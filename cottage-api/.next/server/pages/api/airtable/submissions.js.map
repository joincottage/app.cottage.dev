{"version":3,"file":"../pages/api/airtable/submissions.js","mappings":"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","sources":["webpack://cottage-api/external commonjs \"@sentry/nextjs\"","webpack://cottage-api/external commonjs \"airtable\"","webpack://cottage-api/external commonjs \"cors\"","webpack://cottage-api/./src/apiService/airtable/getDataFromAirtable.ts","webpack://cottage-api/./src/pages/api/airtable/submissions.ts"],"sourcesContent":["module.exports = require(\"@sentry/nextjs\");","module.exports = require(\"airtable\");","module.exports = require(\"cors\");","import base from './base';\n\ninterface RequiredParams {\n  tableName: string;\n  filterByFormula?: string;\n}\n\nexport default async function getDataFromAirtable({ tableName, filterByFormula = \"\" }: RequiredParams): Promise<{ data: any[] }> {\n  const data = await new Promise<any[]>((resolve, reject) => {\n    const data: any[] = [];\n    base(tableName)\n      .select({\n        filterByFormula,\n        view: \"Grid view\",\n      })\n      .eachPage(\n        function page(records, fetchNextPage) {\n          records.forEach(function (record) {\n            data.push(record.fields);\n          });\n\n          fetchNextPage();\n        },\n        function done(err) {\n          if (err) {\n            console.error(err);\n            reject(err);\n            return;\n          }\n\n          resolve(data);\n        }\n      );\n  });\n\n  return { data };\n}","import { NextApiRequest, NextApiResponse } from \"next\";\nimport base from \"src/apiService/airtable/base\";\nimport validateUser from \"src/apiService/softr/validateUser\";\nimport cors from \"cors\";\nimport runMiddleware from \"src/utils/runMiddleware\";\nimport { withSentry } from \"@sentry/nextjs\";\nimport corsOptions from \"../../../apiService/corsOptions\";\nimport getDataFromAirtable from \"src/apiService/airtable/getDataFromAirtable\";\n\nasync function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n): Promise<void> {\n  await runMiddleware(req, res, cors(corsOptions));\n\n  // const isValidUser = await validateUser(req.query.jwtToken as string);\n  // if (!isValidUser) {\n  //   res.status(401).send(\"Unauthorized\");\n  //   return;\n  // }\n\n  switch (req.method) {\n    case \"GET\": {\n      if (req.query.submissionId) {\n        const { data: submission } = await getDataFromAirtable({\n          tableName: \"Submissions\",\n          filterByFormula: `{Record ID} = '${req.query.submissionId}')`,\n        });\n\n        res.json(submission);\n\n        return;\n      }\n\n      if (!req.query.recordId || !req.query.loggedInUserRecordID) {\n        res.status(400).send(\"Bad Request\");\n        return;\n      }\n\n      const { data: submission } = await getDataFromAirtable({\n        tableName: \"Submissions\",\n        filterByFormula: `AND({Record ID (from Users)} = '${req.query.loggedInUserRecordID}', {Record ID (from Tasks)} = '${req.query.recordId}')`,\n      });\n\n      res.json(submission);\n\n      break;\n    }\n    case \"POST\": {\n      const fields = req.body.fields;\n      if (!fields) {\n        res.status(400).send(\"Bad Request\");\n        return;\n      }\n\n      base(\"Submissions\").create(\n        [\n          {\n            fields,\n          },\n        ],\n        function (err: any, records: any) {\n          if (err) {\n            console.error(err);\n            res.status(500).send(\"Error creating records\");\n            throw err;\n          }\n          res.json(records[0].fields);\n        }\n      );\n\n      break;\n    }\n    case \"PATCH\": {\n      if (!req.query.recordId || !req.body.fields) {\n        res.status(400).send(\"Bad Request\");\n        return;\n      }\n\n      // @ts-ignore\n      base(\"Submissions\").update(\n        [\n          {\n            id: req.query.recordId,\n            fields: req.body.fields,\n          },\n        ],\n        function (err: any, records: any) {\n          if (err) {\n            console.error(err);\n            res.status(500).send(\"Error updating submission\");\n            throw err;\n          }\n          res.json(records[0].fields);\n        }\n      );\n\n      break;\n    }\n    default: {\n      console.error(\n        `Unsupported method type ${req.method} made to endpoint ${req.url}`\n      );\n      res.status(404).end();\n      break;\n    }\n  }\n}\n\nexport default withSentry(handler);\n"],"names":["base","getDataFromAirtable","tableName","filterByFormula","data","Promise","resolve","reject","select","view","eachPage","page","records","fetchNextPage","forEach","record","push","fields","done","err","console","error","cors","runMiddleware","withSentry","corsOptions","handler","req","res","method","query","submissionId","submission","json","recordId","loggedInUserRecordID","status","send","body","create","update","id","url","end"],"sourceRoot":""}