{"version":3,"file":"../pages/api/airtable/submissions.js","mappings":"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","sources":["webpack://cottage-api/external commonjs \"@sentry/nextjs\"","webpack://cottage-api/external commonjs \"airtable\"","webpack://cottage-api/external commonjs \"cors\"","webpack://cottage-api/./src/apiService/airtable/getDataFromAirtable.ts","webpack://cottage-api/external commonjs \"axios\"","webpack://cottage-api/./src/apiService/softr/validateUser.ts","webpack://cottage-api/./src/pages/api/airtable/submissions.ts"],"sourcesContent":["module.exports = require(\"@sentry/nextjs\");","module.exports = require(\"airtable\");","module.exports = require(\"cors\");","import base from './base';\n\ninterface RequiredParams {\n  tableName: string;\n  filterByFormula?: string;\n}\n\nexport default async function getDataFromAirtable({ tableName, filterByFormula = \"\" }: RequiredParams): Promise<{ data: any[] }> {\n  const data = await new Promise<any[]>((resolve, reject) => {\n    const data: any[] = [];\n    base(tableName)\n      .select({\n        filterByFormula,\n        view: \"Grid view\",\n      })\n      .eachPage(\n        function page(records, fetchNextPage) {\n          records.forEach(function (record) {\n            data.push(record.fields);\n          });\n\n          fetchNextPage();\n        },\n        function done(err) {\n          if (err) {\n            console.error(err);\n            reject(err);\n            return;\n          }\n\n          resolve(data);\n        }\n      );\n  });\n\n  return { data };\n}","const __WEBPACK_NAMESPACE_OBJECT__ = require(\"axios\");","import axios from \"axios\";\n\n// https://docs.softr.io/my-account/api-settings#validate-an-authentication-token\nexport default async function validateUser(jwt: string) {\n  const response = await axios.post(\n    \"https://sequense.softr.app/v1/api/users/validate-token\",\n    { jwt },\n    { headers: { \"Content-Type\": \"application/json\" } }\n  );\n\n  return response.data;\n}\n","import { NextApiRequest, NextApiResponse } from \"next\";\nimport base from \"src/apiService/airtable/base\";\nimport validateUser from \"src/apiService/softr/validateUser\";\nimport cors from \"cors\";\nimport runMiddleware from \"src/utils/runMiddleware\";\nimport { withSentry } from \"@sentry/nextjs\";\nimport corsOptions from \"../../../apiService/corsOptions\";\nimport getDataFromAirtable from \"src/apiService/airtable/getDataFromAirtable\";\n\nasync function handler(\n  req: NextApiRequest,\n  res: NextApiResponse\n): Promise<void> {\n  await runMiddleware(req, res, cors(corsOptions));\n\n  const isValidUser = await validateUser(req.query.jwtToken as string);\n  if (!isValidUser) {\n    res.status(401).send(\"Unauthorized\");\n    return;\n  }\n\n  switch (req.method) {\n    case \"GET\": {\n      if (req.query.submissionId) {\n        const { data: submission } = await getDataFromAirtable({\n          tableName: \"Submissions\",\n          filterByFormula: `{Record ID} = '${req.query.submissionId}')`,\n        });\n\n        res.json(submission);\n\n        return;\n      }\n\n      if (!req.query.recordId || !req.query.loggedInUserRecordID) {\n        res.status(400).send(\"Bad Request\");\n        return;\n      }\n\n      const { data: submission } = await getDataFromAirtable({\n        tableName: \"Submissions\",\n        filterByFormula: `AND({Record ID (from Users)} = '${req.query.loggedInUserRecordID}', {Record ID (from Tasks)} = '${req.query.recordId}')`,\n      });\n\n      res.json(submission);\n\n      break;\n    }\n    case \"POST\": {\n      const fields = req.body.fields;\n      if (!fields) {\n        res.status(400).send(\"Bad Request\");\n        return;\n      }\n\n      base(\"Submissions\").create(\n        [\n          {\n            fields,\n          },\n        ],\n        function (err: any, records: any) {\n          if (err) {\n            console.error(err);\n            res.status(500).send(\"Error creating records\");\n            throw err;\n          }\n          res.json(records[0].fields);\n        }\n      );\n\n      break;\n    }\n    case \"PATCH\": {\n      if (!req.query.recordId || !req.body.fields) {\n        res.status(400).send(\"Bad Request\");\n        return;\n      }\n\n      // @ts-ignore\n      base(\"Submissions\").update(\n        [\n          {\n            id: req.query.recordId,\n            fields: req.body.fields,\n          },\n        ],\n        function (err: any, records: any) {\n          if (err) {\n            console.error(err);\n            res.status(500).send(\"Error updating submission\");\n            throw err;\n          }\n          res.json(records[0].fields);\n        }\n      );\n\n      break;\n    }\n    default: {\n      console.error(\n        `Unsupported method type ${req.method} made to endpoint ${req.url}`\n      );\n      res.status(404).end();\n      break;\n    }\n  }\n}\n\nexport default withSentry(handler);\n"],"names":["base","getDataFromAirtable","tableName","filterByFormula","data","Promise","resolve","reject","select","view","eachPage","page","records","fetchNextPage","forEach","record","push","fields","done","err","console","error","axios","validateUser","jwt","response","post","headers","cors","runMiddleware","withSentry","corsOptions","handler","req","res","isValidUser","query","jwtToken","status","send","method","submissionId","submission","json","recordId","loggedInUserRecordID","body","create","update","id","url","end"],"sourceRoot":""}